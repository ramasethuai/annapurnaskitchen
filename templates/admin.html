<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Annapurna ‚Äì Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Marcellus&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-card: rgba(249, 244, 234, 0.94);
      --accent: #f28c28;
      --accent-dark: #c45b07;
      --accent-green: #2e7d5b;
      --text-main: #2f2621;
      --muted: #7a7067;
      --border-soft: rgba(255, 255, 255, 0.8);
      --radius-lg: 18px;
      --radius-pill: 999px;
      --shadow-soft: 0 22px 55px rgba(0, 0, 0, 0.45);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      margin: 0;
      background:
        linear-gradient(rgba(0,0,0,0.45), rgba(0,0,0,0.6)),
        url("{{ url_for('static', filename='kitchen-hero.png') }}") center 20% / cover fixed no-repeat;
      color: var(--text-main);
      font-family: "Poppins", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    /* Mobile: softer overlay + non-fixed scrolling BG */
    @media (max-width: 768px) {
      body {
        background:
          linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.5)),
          url("{{ url_for('static', filename='kitchen-hero.png') }}") center 22% / cover no-repeat;
        background-attachment: scroll;
      }
    }

    a {
      color: var(--accent-dark);
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }

    .page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 22px 16px 40px;
    }

    .shell {
      margin-top: 270px; /* <-- main desktop spacing so lady is visible */
      background: radial-gradient(
          circle at top left,
          rgba(255, 243, 220, 0.98) 0,
          rgba(249, 244, 234, 0.96) 40%,
          rgba(250, 246, 237, 0.94) 100%
        );
      border-radius: 28px;
      padding: 18px 18px 24px;
      border: 1px solid var(--border-soft);
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(14px);
    }

    header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      gap: 10px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .logo-circle {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: conic-gradient(from 220deg, #ffb347, #ff7c2a, #ffc857);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 12px 24px rgba(0,0,0,0.35);
      border: 2px solid rgba(255,255,255,0.9);
    }
    .logo-inner {
      width: 46px;
      height: 46px;
      border-radius: 50%;
      background: radial-gradient(circle at top, #fff9ee, #f4cf9f);
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: "Marcellus", serif;
      font-size: 1.4rem;
      color: #3a2310;
      letter-spacing: 0.1em;
    }

    h1 {
      margin: 0;
      font-family: "Marcellus", serif;
      font-size: 1.6rem;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: #23140a;
      text-shadow: 0 1px 0 rgba(255,255,255,0.7);
    }

    .subtitle {
      font-size: 0.85rem;
      color: var(--muted);
    }

    .admin-meta {
      text-align: right;
      font-size: 0.8rem;
      color: var(--muted);
    }

    .admin-meta .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: var(--radius-pill);
      background: rgba(255, 255, 255, 0.8);
      border: 1px solid rgba(0, 0, 0, 0.04);
    }

    /* Tabs */
    .tabs {
      display: inline-flex;
      gap: 6px;
      margin: 10px 0 14px;
      background: rgba(255, 255, 255, 0.75);
      padding: 4px;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(255, 255, 255, 0.85);
    }

    .tab-button {
      border: none;
      background: transparent;
      padding: 6px 14px;
      border-radius: var(--radius-pill);
      font-size: 0.82rem;
      cursor: pointer;
      color: #6e5f54;
    }
    .tab-button.active {
      background: linear-gradient(135deg, #ffb347, #ff7c2a);
      color: #3a2613;
      font-weight: 600;
      box-shadow: 0 6px 14px rgba(0,0,0,0.2);
    }

    .tab-panel {
      display: none;
    }
    .tab-panel.active {
      display: block;
    }

    /* CSV controls */
    .csv-controls {
      margin: 6px 0 14px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      font-size: 0.8rem;
      color: var(--muted);
    }
    .csv-controls label {
      margin-right: 4px;
    }
    #csvMonth {
      padding:4px 6px;
      border-radius:8px;
      border:1px solid #d9cebf;
      font-size:0.85rem;
      background:#fffdf8;
    }
    #downloadCsvBtn {
      border-radius: var(--radius-pill);
      border:none;
      padding:6px 10px;
      font-size:0.8rem;
      cursor:pointer;
      background: #f0e4d5;
      color:#4a4037;
    }
    #downloadCsvBtn:hover {
      background:#e5d6c2;
    }
    #csvStatus {
      font-size:0.78rem;
      color: var(--muted);
    }

    h2 {
      font-size: 1.05rem;
      margin-top: 10px;
      margin-bottom: 4px;
      display:flex;
      align-items:center;
      gap:6px;
    }
    h2 span.icon {
      font-size: 1.1rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 0.85rem;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 14px;
      overflow: hidden;
    }
    th, td {
      border: 1px solid #ded2c4;
      padding: 6px 8px;
      text-align: left;
    }
    th {
      background: #f0e4d5;
      font-weight: 600;
      color:#574534;
    }
    tr:nth-child(even) {
      background: #fbf7f1;
    }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: var(--radius-pill);
      font-size: 0.72rem;
    }
    .badge.green {
      background: #e3f6e5;
      color: #207b32;
    }
    .badge.red {
      background: #fde5e1;
      color: #b1372b;
    }

    .flex {
      display: flex;
      gap: 16px;
      align-items: flex-start;
      flex-wrap: wrap;
      margin-top: 18px;
    }

    .card-panel {
      background: rgba(255, 255, 255, 0.94);
      border-radius: 18px;
      padding: 12px 14px 14px;
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.12);
      border: 1px solid rgba(255, 255, 255, 0.9);
    }

    .small {
      font-size: 0.8rem;
      color: var(--muted);
      margin-bottom: 6px;
    }

    input, textarea, button {
      font-family: inherit;
    }

    .field {
      margin-bottom: 8px;
    }
    .field label {
      font-size: 0.8rem;
      display: block;
      margin-bottom: 3px;
      color: var(--muted);
    }
    .field input, .field textarea {
      width: 100%;
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid #d9cebf;
      box-sizing: border-box;
      font-size: 0.85rem;
      background: #fffdf8;
    }
    .field input:focus,
    .field textarea:focus {
      outline: 2px solid rgba(242, 140, 40, 0.35);
      border-color: var(--accent);
      background: #ffffff;
    }

    button.primary {
      border-radius: var(--radius-pill);
      border: none;
      background: linear-gradient(135deg, #ffb347, #ff7c2a);
      color: #3a2613;
      padding: 6px 14px;
      font-size: 0.85rem;
      cursor: pointer;
      font-weight: 600;
      box-shadow: 0 10px 20px rgba(0,0,0,0.18);
    }
    button.primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 25px rgba(0,0,0,0.22);
    }
    button.primary:active {
      transform: translateY(0);
      box-shadow: 0 7px 14px rgba(0,0,0,0.15);
    }

    button.secondary {
      border-radius: var(--radius-pill);
      border: none;
      background: #f2ece3;
      color: #4a4037;
      padding: 5px 12px;
      font-size: 0.8rem;
      cursor: pointer;
    }
    button.secondary:hover {
      background:#e5dacb;
    }

    pre {
      background: #f9f5ef;
      border-radius: 10px;
      padding: 8px;
      font-size: 0.76rem;
      overflow-x: auto;
      margin-top: 4px;
    }

    #ordersList > div {
      margin-bottom: 8px;
    }

    #paymentStatus {
      min-height: 1.2em;
    }

    /* -------- Responsive spacing so lady's face stays visible -------- */

    @media (max-width: 1200px) {
      .shell { margin-top: 250px; }
    }

    @media (max-width: 1024px) {
      .shell { margin-top: 230px; }
    }

    @media (max-width: 900px) {
      .shell { margin-top: 200px; }
    }

    @media (max-width: 768px) {
      .shell { margin-top: 180px; }
    }

    @media (max-width: 700px) {
      h1 {
        font-size: 1.4rem;
      }

      .shell {
        padding: 14px 12px 18px;
        border-radius: 22px;
        margin-top: 160px;
      }
    }

    @media (max-width: 480px) {
      .shell { margin-top: 140px; }
    }

    /* ----- Weekly menu editor UI ----- */
    .day-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
    }
    .day-button {
      border-radius: var(--radius-pill);
      border: 1px solid #d9cebf;
      background: #f7f1e7;
      color: #6e5f54;
      padding: 4px 10px;
      font-size: 0.8rem;
      cursor: pointer;
    }
    .day-button.active {
      background: linear-gradient(135deg, #ffb347, #ff7c2a);
      color: #3a2613;
      border-color: #f28c28;
      font-weight: 600;
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .menu-items-list {
      border-radius: 10px;
      background: #f9f4ec;
      border: 1px solid #eadfce;
      padding: 6px 8px;
      max-height: 260px;
      overflow-y: auto;
    }
    .menu-item-row {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 8px;
      padding: 4px 0;
      border-bottom: 1px dashed #e0d7c7;
      font-size: 0.8rem;
    }
    .menu-item-row:last-child {
      border-bottom: none;
    }
    .menu-item-main {
      flex: 1;
      min-width: 0;
    }
    .menu-item-main strong {
      font-weight: 600;
    }
    .small-muted {
      font-size: 0.75rem;
      color: var(--muted);
      margin-left: 4px;
    }
    .menu-item-meta {
      text-align: right;
      min-width: 80px;
    }
    .menu-item-actions button {
      margin-top: 2px;
      font-size: 0.75rem;
      padding: 3px 8px;
    }
    .menu-item-form {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 2fr) minmax(0, 1fr) minmax(0, 1fr) auto;
      gap: 6px;
      align-items: center;
    }
    .menu-item-form input {
      font-size: 0.8rem;
      padding: 5px 7px;
    }
    @media (max-width: 700px) {
      .menu-item-form {
        grid-template-columns: minmax(0, 1fr);
      }
    }

  </style>
</head>
<body>
  <div class="page">
    <div class="shell">
      <header>
        <div class="brand">
          <div class="logo-circle">
            <div class="logo-inner">AK</div>
          </div>
          <div>
            <h1>Annapurna's Kitchen ‚Äì Admin</h1>
            <div class="subtitle">Orders ‚Ä¢ Payments ‚Ä¢ Customer Balances</div>
          </div>
        </div>
        <div class="admin-meta">
          <div class="pill">
            <span>üë©‚Äçüç≥</span>
            <span>
              Logged in as {{ session.admin_username or "admin" }} ¬∑
              <a href="/admin/logout">Logout</a>
            </span>
          </div>
        </div>
      </header>

      <!-- Tabs -->
      <div class="tabs">
        <button class="tab-button active" data-tab="orders">üìä Orders &amp; Payments</button>
        <button class="tab-button" data-tab="menujson">üìã Weekly Menu JSON</button>
        <button class="tab-button" data-tab="users">üßë‚Äçüç≥ Admin Users</button>
      </div>
      

      <!-- ===== TAB: ORDERS & PAYMENTS ===== -->
      <div class="tab-panel active" id="tab-orders">
        <div class="csv-controls">
          <label for="csvMonth">
            Export monthly summary (for accountant):
          </label>
          <input id="csvMonth" type="month" />
          <button id="downloadCsvBtn" class="secondary">Download CSV</button>
          <span id="csvStatus"></span>
        </div>

        <h2><span class="icon">üë•</span> Customers &amp; Balances</h2>
        <p class="small">
          Grouped by phone number. Balance = total ordered (all time) ‚Äì total paid (all time).
        </p>
        <table id="summaryTable">
          <thead>
            <tr>
              <th>Phone</th>
              <th>Name</th>
              <th>Total Ordered</th>
              <th>Total Paid</th>
              <th>Balance</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <div class="flex">
          <div class="card-panel" style="flex: 2;">
            <h2><span class="icon">üßæ</span> Orders for Selected Customer</h2>
            <p class="small" id="selectedCustomerInfo">Select a customer row to see orders.</p>
            <div id="ordersList"></div>
          </div>

          <div class="card-panel" style="flex: 1;">
            <h2><span class="icon">üíµ</span> Add Payment</h2>
            <p class="small">Link a payment to a customer's phone number.</p>
            <div class="field">
              <label for="payPhone">Phone</label>
              <input id="payPhone" type="text" placeholder="Customer phone" />
            </div>
            <div class="field">
              <label for="payAmount">Amount</label>
              <input id="payAmount" type="number" step="0.01" placeholder="e.g. 20.00" />
            </div>
            <div class="field">
              <label for="payNote">Note (optional)</label>
              <textarea id="payNote" rows="2" placeholder="e.g. Cash received, Zelle, etc."></textarea>
            </div>
            <button id="addPaymentBtn" class="primary">Add Payment</button>
            <p class="small" id="paymentStatus"></p>

            <hr style="margin:10px 0; border:none; border-top:1px dashed #e0d7c7;" />

            <h2><span class="icon">üìö</span> Payments for Selected Customer</h2>
            <div id="paymentsList" class="small"></div>
          </div>
        </div>
      </div>

      <!-- ===== TAB: WEEKLY MENU (CONFIG) ===== -->
      <div class="tab-panel" id="tab-menujson">
        <div class="card-panel">
          <h2><span class="icon">üìã</span> Weekly Menu</h2>
          <p class="small">
            Use this section to manage the weekly menu by day. Customers will see these items on the main page.
          </p>

          <!-- Day selector -->
          <div class="field">
            <label>Day of week</label>
            <div class="day-buttons" id="menuDayButtons">
              <button type="button" class="day-button active" data-day="Monday">Monday</button>
              <button type="button" class="day-button" data-day="Tuesday">Tuesday</button>
              <button type="button" class="day-button" data-day="Wednesday">Wednesday</button>
              <button type="button" class="day-button" data-day="Thursday">Thursday</button>
              <button type="button" class="day-button" data-day="Friday">Friday</button>
              <button type="button" class="day-button" data-day="Saturday">Saturday</button>
              <button type="button" class="day-button" data-day="Sunday">Sunday</button>
            </div>
          </div>

          <!-- Items list for selected day -->
          <div class="field">
            <label>Items for <span id="menuCurrentDayLabel">Monday</span></label>
            <div id="menuItemsList" class="menu-items-list">
              <p class="small">No items yet for this day.</p>
            </div>
          </div>

          <!-- Add item form -->
          <div class="field">
            <label>Add new item</label>
            <div class="menu-item-form">
              <input id="menuItemName" type="text" placeholder="Name, e.g. Chana Saag" />
              <input id="menuItemDescription" type="text" placeholder="Description (optional)" />
              <input id="menuItemWeight" type="text" placeholder="Weight / size, e.g. 16 oz" />
              <input id="menuItemPrice" type="number" step="0.01" placeholder="Price, e.g. 8.00" />
              <button type="button" id="menuAddItemBtn" class="primary">Add item</button>
            </div>
            <p class="small" id="menuItemFormStatus"></p>
          </div>

          <hr style="margin:10px 0; border:none; border-top:1px dashed #e0d7c7;" />

          <!-- Week text / cutoffs / note -->
          <div class="field">
            <label for="menuWeekText">Week range text</label>
            <input id="menuWeekText" type="text" placeholder="e.g. Week Menu: Nov 24 ‚Äì Nov 28" />
          </div>

          <div class="field">
            <label>Daily cutoff times (24-hr)</label>
            <div style="display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:6px 14px;">
              <div class="field">
                <label>Monday</label>
                <input id="menuCutoffMonday" type="text" placeholder="12:00" />
              </div>
              <div class="field">
                <label>Tuesday</label>
                <input id="menuCutoffTuesday" type="text" placeholder="12:00" />
              </div>
              <div class="field">
                <label>Wednesday</label>
                <input id="menuCutoffWednesday" type="text" placeholder="12:00" />
              </div>
              <div class="field">
                <label>Thursday</label>
                <input id="menuCutoffThursday" type="text" placeholder="12:00" />
              </div>
              <div class="field">
                <label>Friday</label>
                <input id="menuCutoffFriday" type="text" placeholder="12:00" />
              </div>
            </div>
          </div>

          <div class="field">
            <label for="menuSpecialNote">Special note</label>
            <textarea id="menuSpecialNote" rows="3" placeholder="e.g. Order by Thursday 8 PM. Closed on Friday this week."></textarea>
          </div>

          <!-- Advanced JSON view (kept for compatibility, auto-synced with UI) -->
          <details class="field" style="margin-top: 8px;">
            <summary style="cursor:pointer; font-size:0.82rem; color: var(--muted);">
              Advanced: JSON view (optional)
            </summary>
            <label for="menuJsonEditor" style="font-size:0.8rem; margin-top:6px;">Menu JSON (auto-generated)</label>
            <textarea id="menuJsonEditor" rows="10"
              style="font-family: SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size:0.78rem;"></textarea>
            <div style="display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-top:4px;">
              <button class="secondary" id="copyMenuJsonBtn" type="button">Copy JSON</button>
            </div>
          </details>

          <div style="display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-top:8px;">
            <button class="primary" id="saveMenuConfigBtn" type="button">Save &amp; apply to website</button>
            <p class="small" id="menuJsonStatus"></p>
          </div>
        </div>
      </div>

      <!-- ===== TAB: ADMIN USERS ===== -->
    <div class="tab-panel" id="tab-users">
      <div class="card-panel">
        <h2><span class="icon">üßë‚Äçüç≥</span> Admin Users</h2>
        <p class="small">
          Create additional admin accounts. Each admin can log in to manage orders & payments.
        </p>

        <div class="flex" style="margin-top: 10px;">
          <!-- Left: list of admins -->
          <div style="flex: 1;">
            <h3 style="font-size:0.9rem; margin-bottom:4px;">Existing Admins</h3>
            <div id="adminUsersList" class="small"></div>
          </div>

          <!-- Right: create new admin -->
          <div class="card-panel" style="flex: 1; margin-top:0;">
            <h3 style="font-size:0.9rem; margin-bottom:4px;">Create New Admin</h3>
            <div class="field">
              <label for="newAdminUsername">Username</label>
              <input id="newAdminUsername" type="text" placeholder="e.g. hari_admin" />
            </div>
            <div class="field">
              <label for="newAdminPassword">Password</label>
              <input id="newAdminPassword" type="password" placeholder="At least 6 characters" />
            </div>
            <button id="createAdminBtn" class="primary" style="margin-top:4px;">Create Admin</button>
            <p class="small" id="adminUsersStatus"></p>
          </div>
        </div>
      </div>
    </div>

    </div>
  </div>

  <script>
    // ----- Load customer summary -----
    async function loadSummary() {
      const tbody = document.querySelector("#summaryTable tbody");
      tbody.innerHTML = "<tr><td colspan='6'>Loading...</td></tr>";

      const res = await fetch("/api/admin/summary");
      const data = await res.json();

      if (!Array.isArray(data) || data.length === 0) {
        tbody.innerHTML = "<tr><td colspan='6'>No customers yet.</td></tr>";
        return;
      }

      tbody.innerHTML = "";
      data.forEach(row => {
        const tr = document.createElement("tr");
        tr.dataset.phone = row.phone;
        tr.innerHTML = `
          <td>${row.phone}</td>
          <td>${row.name || ""}</td>
          <td>$${row.total_ordered.toFixed(2)}</td>
          <td>$${row.total_paid.toFixed(2)}</td>
          <td>
            $${row.balance.toFixed(2)}
            ${
              row.balance > 0
                ? `<span class="badge red">Due</span>`
                : `<span class="badge green">Paid</span>`
            }
          </td>
          <td><button class="secondary" data-phone="${row.phone}">View</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ----- Orders for a specific phone -----
    async function loadOrdersForPhone(phone) {
      const info = document.getElementById("selectedCustomerInfo");
      const container = document.getElementById("ordersList");
      const payPhone = document.getElementById("payPhone");

      payPhone.value = phone;
      info.textContent = "Orders for: " + phone;
      container.innerHTML = "Loading...";

      const res = await fetch("/api/admin/orders?phone=" + encodeURIComponent(phone));
      const data = await res.json();

      if (!Array.isArray(data) || data.length === 0) {
        container.innerHTML = "<p class='small'>No orders for this customer yet.</p>";
        document.getElementById("paymentsList").innerHTML = "<p>No payments recorded yet for this customer.</p>";
        return;
      }

      container.innerHTML = "";
      data.forEach(order => {
        const div = document.createElement("div");
        div.style.borderBottom = "1px solid #e0d7c7";
        div.style.padding = "6px 0";
        const createdDate = new Date(order.created_at).toLocaleString();
        div.innerHTML = `
          <div><strong>Order #${order.id}</strong> ‚Ä¢ ${createdDate} ‚Ä¢ Total: $${order.total.toFixed(2)}</div>
          <pre>${JSON.stringify(order.data, null, 2)}</pre>
        `;
        container.appendChild(div);
      });

      loadPaymentsForPhone(phone);
    }

    // ----- Payments for a specific phone -----
    async function loadPaymentsForPhone(phone) {
      const container = document.getElementById("paymentsList");
      container.innerHTML = "Loading...";

      const res = await fetch("/api/admin/payments?phone=" + encodeURIComponent(phone));
      const data = await res.json();

      if (!Array.isArray(data) || data.length === 0) {
        container.innerHTML = "<p>No payments recorded yet for this customer.</p>";
        return;
      }

      container.innerHTML = "";
      data.forEach(p => {
        const d = new Date(p.created_at).toLocaleString();
        const line = document.createElement("div");
        line.textContent = `${d} ‚Äì $${p.amount.toFixed(2)} (${p.note || "no note"})`;
        container.appendChild(line);
      });
    }

    // Row "View" buttons
    document.addEventListener("click", (e) => {
      const btn = e.target.closest("button.secondary[data-phone]");
      if (btn) {
        const phone = btn.dataset.phone;
        loadOrdersForPhone(phone);
      }
    });

    // ----- Add Payment -----
    document.getElementById("addPaymentBtn").addEventListener("click", async () => {
      const phone = document.getElementById("payPhone").value.trim();
      const amount = parseFloat(document.getElementById("payAmount").value);
      const note = document.getElementById("payNote").value.trim();
      const status = document.getElementById("paymentStatus");

      if (!phone) {
        alert("Phone is required.");
        return;
      }
      if (!amount || amount <= 0) {
        alert("Amount must be > 0.");
        return;
      }

      status.textContent = "Saving payment...";
      try {
        const res = await fetch("/api/admin/payments", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ phone, amount, note })
        });
        const data = await res.json();
        if (!res.ok) {
          throw new Error(data.error || "Unknown error");
        }
        status.textContent = "Payment saved.";
        document.getElementById("payAmount").value = "";
        document.getElementById("payNote").value = "";

        loadSummary();
        loadPaymentsForPhone(phone);
      } catch (err) {
        console.error(err);
        status.textContent = "Error saving payment.";
        alert("Error saving payment: " + err.message);
      }
    });

    // ----- CSV Download -----
    document.getElementById("downloadCsvBtn").addEventListener("click", () => {
      const monthInput = document.getElementById("csvMonth");
      const status = document.getElementById("csvStatus");
      const val = monthInput.value; // "YYYY-MM"

      if (!val) {
        alert("Please choose a month first.");
        return;
      }

      status.textContent = "Preparing CSV...";
      const url = "/api/admin/summary_csv?month=" + encodeURIComponent(val);
      window.location.href = url;

      setTimeout(() => {
        status.textContent = "";
      }, 3000);
    });

    // ----- Tabs -----
    document.querySelectorAll(".tab-button").forEach(btn => {
      btn.addEventListener("click", () => {
        const tab = btn.dataset.tab;

        document.querySelectorAll(".tab-button").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");

        document.querySelectorAll(".tab-panel").forEach(p => p.classList.remove("active"));
        document.getElementById("tab-" + tab).classList.add("active");

        if (tab === "users") {
          loadAdminUsers();
        }
      });
    });


    // ----- Weekly Menu JSON defaults & copy -----
const defaultMenuJson = `{
  "Monday": [
    {
      "id": "carrot_rasam",
      "name": "Carrot Rasam",
      "sizes": [
        { "label": "16 oz", "price": 5.0 }
      ]
    },
    {
      "id": "tomato_pappu",
      "name": "Tomato Pappu (Toor Dal + Tomato)",
      "sizes": [
        { "label": "16 oz", "price": 5.0 }
      ]
    },
    {
      "id": "beans_carrot_fry",
      "name": "Beans & Carrot Fry",
      "sizes": [
        { "label": "8 oz", "price": 4.0 },
        { "label": "16 oz", "price": 8.0 }
      ]
    }
  ],
  "Tuesday": [
    {
      "id": "chana_saag",
      "name": "Chana Saag (Chickpeas + Spinach)",
      "sizes": [
        { "label": "8 oz", "price": 4.0 },
        { "label": "16 oz", "price": 9.0 }
      ]
    },
    {
      "id": "potato_fry",
      "name": "Potato Fry",
      "sizes": [
        { "label": "8 oz", "price": 3.0 },
        { "label": "16 oz", "price": 6.0 }
      ]
    }
  ],
  "Wednesday": [
    {
      "id": "tofu_burji",
      "name": "Tofu Burji",
      "sizes": [
        { "label": "8 oz", "price": 5.0 },
        { "label": "16 oz", "price": 10.0 }
      ]
    },
    {
      "id": "egg_pulusu",
      "name": "Egg Pulusu",
      "sizes": [
        { "label": "8 oz (1 egg)", "price": 4.0 },
        { "label": "16 oz (2 eggs)", "price": 8.0 }
      ]
    }
  ],
  "Thursday": [
    {
      "id": "mushroom_capsicum",
      "name": "Mushroom & Capsicum",
      "sizes": [
        { "label": "8 oz", "price": 6.0 },
        { "label": "16 oz", "price": 12.0 }
      ]
    },
    {
      "id": "baingan_bhartha",
      "name": "Baingan Bharta (Smoked Eggplant)",
      "sizes": [
        { "label": "8 oz", "price": 5.0 },
        { "label": "16 oz", "price": 8.0 }
      ]
    }
  ],
  "Friday": [
    {
      "id": "chilli_paneer_pulav",
      "name": "Chilli Paneer Pulav",
      "sizes": [
        { "label": "10.99 (single size)", "price": 10.99 }
      ]
    },
    {
      "id": "kaju_butter_masala",
      "name": "Kaju Butter Masala",
      "sizes": [
        { "label": "8 oz", "price": 4.0 },
        { "label": "16 oz", "price": 10.0 }
      ]
    }
  ]
}`;

// ----- Weekly menu admin UI -----
let adminMenuData = {};
const ADMIN_MENU_DAYS = [
  "Monday",
  "Tuesday",
  "Wednesday",
  "Thursday",
  "Friday",
  "Saturday",
  "Sunday"
];
let currentAdminMenuDay = "Monday";

function syncAdminMenuJsonTextarea() {
  const jsonEl = document.getElementById("menuJsonEditor");
  if (!jsonEl) return;
  try {
    jsonEl.value = JSON.stringify(adminMenuData, null, 2);
  } catch (e) {
    console.error("Failed to stringify admin menu data:", e);
  }
}

function initAdminMenuFromJsonText(text) {
  try {
    const parsed = JSON.parse(text);
    if (parsed && typeof parsed === "object") {
      adminMenuData = parsed;
    } else {
      adminMenuData = {};
    }
  } catch (e) {
    console.error("Invalid menu JSON in admin, starting from defaults:", e);
    try {
      adminMenuData = JSON.parse(defaultMenuJson);
    } catch {
      adminMenuData = {};
    }
  }

  // Ensure all days exist
  ADMIN_MENU_DAYS.forEach((day) => {
    if (!Array.isArray(adminMenuData[day])) {
      adminMenuData[day] = [];
    }
  });

  syncAdminMenuJsonTextarea();
}

function renderAdminMenuDay(day) {
  currentAdminMenuDay = day;
  const labelEl = document.getElementById("menuCurrentDayLabel");
  const listEl = document.getElementById("menuItemsList");
  if (labelEl) labelEl.textContent = day;
  if (!listEl) return;

  // Highlight active day button
  document.querySelectorAll(".day-button").forEach((btn) => {
    btn.classList.toggle("active", btn.dataset.day === day);
  });

  listEl.innerHTML = "";
  const items = adminMenuData[day] || [];
  if (!items.length) {
    listEl.innerHTML = "<p class='small'>No items yet for this day.</p>";
    return;
  }

  items.forEach((item, index) => {
    const row = document.createElement("div");
    row.className = "menu-item-row";

    const firstSize =
      item.sizes && item.sizes[0]
        ? item.sizes[0]
        : { label: "", price: 0 };
    const priceNum = Number(firstSize.price || 0);

    row.innerHTML = `
      <div class="menu-item-main">
        <div>
          <strong>${item.name || ""}</strong>
          ${
            firstSize.label
              ? `<span class="small-muted">${firstSize.label}</span>`
              : ""
          }
        </div>
        ${
          item.description
            ? `<div class="small">${item.description}</div>`
            : ""
        }
      </div>
      <div class="menu-item-meta">
        <div class="small">$${priceNum.toFixed(2)}</div>
        <div class="menu-item-actions">
          <button type="button" class="secondary" data-index="${index}">Remove</button>
        </div>
      </div>
    `;

    const removeBtn = row.querySelector("button[data-index]");
    if (removeBtn) {
      removeBtn.addEventListener("click", () => {
        adminMenuData[day].splice(index, 1);
        syncAdminMenuJsonTextarea();
        renderAdminMenuDay(day);
      });
    }

    listEl.appendChild(row);
  });
}

function setupAdminMenuUi() {
  const dayButtons = document.querySelectorAll(".day-button");
  dayButtons.forEach((btn) => {
    btn.addEventListener("click", () => {
      const day = btn.dataset.day;
      if (!day) return;
      renderAdminMenuDay(day);
    });
  });

  const addBtn = document.getElementById("menuAddItemBtn");
  if (addBtn) {
    addBtn.addEventListener("click", () => {
      const nameEl = document.getElementById("menuItemName");
      const descEl = document.getElementById("menuItemDescription");
      const weightEl = document.getElementById("menuItemWeight");
      const priceEl = document.getElementById("menuItemPrice");
      const statusEl = document.getElementById("menuItemFormStatus");

      const name = (nameEl.value || "").trim();
      const description = (descEl.value || "").trim();
      const weight = (weightEl.value || "").trim();
      const price = parseFloat(priceEl.value || "");

      if (!name) {
        statusEl.textContent = "Name is required.";
        return;
      }
      if (!weight) {
        statusEl.textContent = "Weight / size is required.";
        return;
      }
      if (!price || price <= 0) {
        statusEl.textContent = "Price must be > 0.";
        return;
      }

      const id =
        name
          .toLowerCase()
          .replace(/[^a-z0-9]+/g, "-")
          .replace(/(^-|-$)/g, "") || `item-${Date.now()}`;

      const newItem = {
        id,
        name,
        description,
        sizes: [
          {
            label: weight,
            price
          }
        ]
      };

      if (!Array.isArray(adminMenuData[currentAdminMenuDay])) {
        adminMenuData[currentAdminMenuDay] = [];
      }
      adminMenuData[currentAdminMenuDay].push(newItem);

      // Clear form & status
      nameEl.value = "";
      descEl.value = "";
      weightEl.value = "";
      priceEl.value = "";
      statusEl.textContent = "Item added.";
      setTimeout(() => {
        statusEl.textContent = "";
      }, 2000);

      syncAdminMenuJsonTextarea();
      renderAdminMenuDay(currentAdminMenuDay);
    });
  }
}

async function initMenuJsonTab() {
  const jsonEl = document.getElementById("menuJsonEditor");
  const weekEl = document.getElementById("menuWeekText");
  const noteEl = document.getElementById("menuSpecialNote");
  const cutoffs = {
    Monday: document.getElementById("menuCutoffMonday"),
    Tuesday: document.getElementById("menuCutoffTuesday"),
    Wednesday: document.getElementById("menuCutoffWednesday"),
    Thursday: document.getElementById("menuCutoffThursday"),
    Friday: document.getElementById("menuCutoffFriday")
  };

  // 1) Try to load existing config from backend
  try {
    const res = await fetch("/api/admin/menu_config");
    if (res.ok) {
      const cfg = await res.json();

      if (cfg.menu_json && !jsonEl.value.trim()) {
        jsonEl.value = cfg.menu_json;
      }
      if (cfg.week_text && !weekEl.value.trim()) {
        weekEl.value = cfg.week_text;
      }
      if (cfg.special_note && !noteEl.value.trim()) {
        noteEl.value = cfg.special_note;
      }
      if (cfg.cutoffs) {
        if (cutoffs.Monday && !cutoffs.Monday.value.trim()) {
          cutoffs.Monday.value = cfg.cutoffs.Monday || "";
        }
        if (cutoffs.Tuesday && !cutoffs.Tuesday.value.trim()) {
          cutoffs.Tuesday.value = cfg.cutoffs.Tuesday || "";
        }
        if (cutoffs.Wednesday && !cutoffs.Wednesday.value.trim()) {
          cutoffs.Wednesday.value = cfg.cutoffs.Wednesday || "";
        }
        if (cutoffs.Thursday && !cutoffs.Thursday.value.trim()) {
          cutoffs.Thursday.value = cfg.cutoffs.Thursday || "";
        }
        if (cutoffs.Friday && !cutoffs.Friday.value.trim()) {
          cutoffs.Friday.value = cfg.cutoffs.Friday || "";
        }
      }
    }
  } catch (err) {
    console.error("Failed to load menu_config from backend:", err);
  }

  // 2) Fallback defaults if still empty
  if (jsonEl && !jsonEl.value.trim()) {
    jsonEl.value = defaultMenuJson;   // your existing default JSON string
  }
  if (weekEl && !weekEl.value.trim()) {
    weekEl.value = "Week Menu: Nov 17 ‚Äì Nov 21";
  }
  if (noteEl && !noteEl.value.trim()) {
    noteEl.value = "";
  }
  if (cutoffs.Monday && !cutoffs.Monday.value.trim()) {
    cutoffs.Monday.value = "12:00";
    cutoffs.Tuesday.value = "12:00";
    cutoffs.Wednesday.value = "12:00";
    cutoffs.Thursday.value = "12:00";
    cutoffs.Friday.value = "12:00";
  }

  // Initialize admin menu data from whatever JSON we have now
  initAdminMenuFromJsonText(jsonEl.value || defaultMenuJson);
  setupAdminMenuUi();
  renderAdminMenuDay(currentAdminMenuDay);
}


    // ----- Admin Users: list & create -----
async function loadAdminUsers() {
  const container = document.getElementById("adminUsersList");
  if (!container) return;
  container.innerHTML = "Loading...";

  try {
    const res = await fetch("/api/admin/admins");
    if (!res.ok) {
      container.innerHTML = "Unable to load admins.";
      return;
    }
    const admins = await res.json();
    if (!Array.isArray(admins) || admins.length === 0) {
      container.innerHTML = "<p>No admin users yet.</p>";
      return;
    }

    const list = document.createElement("ul");
    list.style.listStyle = "none";
    list.style.paddingLeft = "0";

    admins.forEach(a => {
      const li = document.createElement("li");
      li.textContent = a.username;
      li.style.padding = "2px 0";
      list.appendChild(li);
    });

    container.innerHTML = "";
    container.appendChild(list);
  } catch (err) {
    console.error(err);
    container.innerHTML = "Error loading admins.";
  }
}

const createAdminBtn = document.getElementById("createAdminBtn");
if (createAdminBtn) {
  createAdminBtn.addEventListener("click", async () => {
    const usernameEl = document.getElementById("newAdminUsername");
    const passwordEl = document.getElementById("newAdminPassword");
    const statusEl = document.getElementById("adminUsersStatus");

    const username = usernameEl.value.trim();
    const password = passwordEl.value;

    if (!username || !password) {
      alert("Username and password are required.");
      return;
    }
    if (password.length < 6) {
      alert("Password should be at least 6 characters.");
      return;
    }

    statusEl.textContent = "Creating admin...";
    try {
      const res = await fetch("/api/admin/admins", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, password })
      });
      const data = await res.json();
      if (!res.ok) {
        statusEl.textContent = data.error || "Error creating admin.";
        return;
      }

      statusEl.textContent = "Admin created successfully.";
      usernameEl.value = "";
      passwordEl.value = "";
      loadAdminUsers();
    } catch (err) {
      console.error(err);
      statusEl.textContent = "Error creating admin.";
    }
  });
}


    const copyBtn = document.getElementById("copyMenuJsonBtn");
    if (copyBtn) {
      copyBtn.addEventListener("click", () => {
        const jsonEl = document.getElementById("menuJsonEditor");
        const status = document.getElementById("menuJsonStatus");

        jsonEl.select();
        jsonEl.setSelectionRange(0, 99999);
        const ok = document.execCommand("copy");

        status.textContent = ok
          ? "JSON copied to clipboard."
          : "Could not copy JSON (please copy manually).";
        setTimeout(() => (status.textContent = ""), 4000);
      });
    }

    // Save menu config (uses JSON kept in sync with the UI)
    const saveMenuBtn = document.getElementById("saveMenuConfigBtn");
    if (saveMenuBtn) {
      saveMenuBtn.addEventListener("click", async () => {
        const jsonEl = document.getElementById("menuJsonEditor");
        const weekEl = document.getElementById("menuWeekText");
        const noteEl = document.getElementById("menuSpecialNote");
        const status = document.getElementById("menuJsonStatus");

        const cutoffs = {
          Monday: document.getElementById("menuCutoffMonday").value.trim(),
          Tuesday: document.getElementById("menuCutoffTuesday").value.trim(),
          Wednesday: document.getElementById("menuCutoffWednesday").value.trim(),
          Thursday: document.getElementById("menuCutoffThursday").value.trim(),
          Friday: document.getElementById("menuCutoffFriday").value.trim()
        };

        const payload = {
          menu_json: jsonEl.value,
          week_text: weekEl.value.trim(),
          special_note: noteEl.value.trim(),
          cutoffs
        };

        status.textContent = "Saving...";
        try {
          const res = await fetch("/api/admin/menu_config", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
          const data = await res.json();
          if (!res.ok) {
            throw new Error(data.error || "Error saving config");
          }
          status.textContent = "Saved. Homepage menu will use this config.";
          setTimeout(() => {
            status.textContent = "";
          }, 4000);
        } catch (err) {
          console.error(err);
          status.textContent = "Error saving config.";
        }
      });
    }

    // Initial load
    loadSummary();
    initMenuJsonTab();
    loadAdminUsers(); // optional ‚Äì you can leave it lazy/commented out and only load when tab is opened
  </script>
</body>
</html>
